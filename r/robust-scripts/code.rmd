```{r echo=F}
opts_chunk$set(eval=FALSE,warning=FALSE, echo=FALSE, message=FALSE, results="asis", fig.width=6, fig.height=6, dev="CairoPNG")    
```

# How to make an R script robust

## Comments

Commenting in R is very simple. 
```{r}
x <- 3 # everything after the '#' symbol is not executed
```

The important question is *what* to comment and *how*. 
Roxygen provides a useful framework for documenting functions
(https://cran.r-project.org/web/packages/roxygen2/vignettes/roxygen2.html).
For example:

```{r}
#' My very cool scatterplot
#'
#' @param x x-coordinates of points (numeric vector)
#' @param y y-coordinates of points (numeric vector)
#' @param line whether to plot regression line (logical) (Default: T)
#' @return Linear model fit for y~x.
#' @examples
#' x <- c(1,2,3,3)
#' y <- c(2,2,4,5)
#' fit <- myscatterplot(x,y,line=F)
#'
myscatterplot <- function(x,y,line=T) {
  plot(x,y,pch=19)
  fit <- lm(y~x)
  if (line)
    abline(fit, col="red", lty="dashed")
  return(fit)
}
```

Something similar to this is very useful to include 
at the beginning of scripts:

* Explaining what the script does.
* Describing all inputs to the script such as files that are loaded.
* Defining the expected output.

## Keeping code short

* Short lines

    ```{r}
    dat.avg <- sapply(by(dat, as.factor(probes$symbol), colMeans), identity)

    symbols <- as.factor(probes$symbol)
    dat.list <- by(dat, symbols, colMeans)
    dat.avg <- sapply(dat.list, identity)
    ```

* Short functions/scripts

  My general rule is that the entire script or function
	should fit on one screen.  If this is not possible, then
	I break it up into functions. 

## Assertions

It is useful to test assumptions about user input
and the values of variables throughout the script
to ensure that you are working with expected/possible values.

For example: 
```{r}
if (!is.numeric(x))
  stop("'x' is not numeric")
if (x < 50)
  stop("'x' is too small")
```

R provides a shorthand for this
using the `stopifnot()` function.
```{r}
stopifnot(is.numeric(x) && x >= 50)
```

Although it requires additional lines of code,
the following would be more informative to the
user if one of these conditions fails:
```{r}
stopifnot(is.numeric(x))
stopifnot(x >= 50)
```

Adding assertions has 3 benefits:

1. They catch errors before they generate crash the script and
    generate mysterious outputs.
2. They force the script writer to think more concretely
    about the values the variables could take.
3. They document the script.

## Modular development

Split up code as much as possible into independent
functions and packages.

As an example, I have the following code that simulates 
some random data and generates two plots. 
```{r}
x1 <- rnorm(100)
y1 <- x1 + rnorm(length(x1))
plot(x1, y1, pch=19)
abline(lm(y1~x1), col="red", lty="dashed")
x2 <- rnorm(100)
y2 <- x1 + x2 + rnorm(length(x1))
plot(x2, y2, pch=19)
abline(lm(y2~x2), col="red", lty="dashed")
```

There are two problems with this script.  
1. *It mixes computation and output.*  

    This makes the code more complex
    because the reader has to think about computation and output. 
    
2. *It generates two identical plots with different code.*

    - If we later decide to change the plots, 
    we need to remember to make the same changes to the code for both. 
    - If we later want to generate similar plots in another script, 
    we have carefully modify the code to fit the new script.

The following code is easier to read, modify and reuse. 
```{r}
## data simulation
x1 <- rnorm(100)
y1 <- x1 + rnorm(length(x1))
x2 <- rnorm(100)
y2 <- x1 + x2 + rnorm(length(x1))

## scatterplots 
myscatter <- function(x,y) {
  plot(x1, y1, pch=19)
  fit <- lm(y~x)
  abline(fit, col="red", lty="dashed")
  return(fit)
}
myscatter(x1,y1)
myscatter(x2,y2)
```

---

## Exceptions

The following script will stop when attempting to calculate `r`
just before printing the message at the end.
```{r}
x <- c(1,2,3)
y <- NA 
## ... 
## lots of code 
## ...
r <- cor(x,y)
cat("The correlation is", r, "\n")
```


```{r}
x <- c(1,2,3)
y <- NA 
## ... 
## lots of code 
## ...
r <- tryCatch(cor(x,y), 
              error=function(e) NaN) 
cat("The correlation is", r, "\n")
```




## Debugging

```{r}
if (x < 50)
    print("x is very small, how did this happen?!")
```

```{r}
if (x < 50)
    browser() 
```
