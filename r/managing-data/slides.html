<!DOCTYPE html>
<html>
  <head>
    <title>How to manage data</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://perishky.github.io/r/robust-scripts/styles.css">
  </head>
  <body>
    <textarea id="source">

count: false
class: left, bottom

# How to manage data
&nbsp;
### Matthew Suderman
#### Lecturer in Epigenetic Epidemiology

&lt;img src="IEU-logo-colour.png" width="50%"&gt;
---
layout: true

.logo[.mrcieu[
MRC Integrative Epidemiology Unit&nbsp;&nbsp;&nbsp;&nbsp;
]]

---

## Typical operations in molecular epidemiology

* Load a massive file into memory and run some simple tests
* Convert a continuous variable to binary
* Transform a categorical variable (factors and levels)
* Combine multiple variables into a single variable
* Analyse a genomic dataset with a phenotype dataset
* Calculate variable summaries by 'group' 
* Transform a matrix by summarizing features

--- 

## Basic steps

* Loading 
* Saving
* Querying 
* Modifying 
* Merging 

previously: read.csv, write.csv, read.table, write.table

---

## Loading spreadsheets

```{r}
read.csv
library(readxl)
```

---

## Saving spreadsheets

---

## STATA and SPSS

foreign

readstata13::read.dta13 loses information when reading in .dta files because it ignores all the comments on the variables. This is a pain with alspac data because it means you have no idea what the variables correspond to because each of the column names aren't descriptions of the variables, e.g. the column "fm4ms100" is actually height measured at the FOM4 time point...

haven::read_dta
---

## RData files

---

## RDS files

---

## Large files

```{r}
library(gdsfmt)
```

```{r}
library(MatrixEQTL}

snps1 = SlicedData$new()
```

```{r}
library(readr)
read_csv() ## read_tsv()
```


---

## Manipulate observations

Filter

```{r}
data.jan <- data[data$month == "January",]
data.jan <- data[which(data$month == "January"),]

data.win <- data[which(data$month %in% c("December","January","February","March")),]
```

Reorder

```{r}
idx <- order(data$last, data$first, decreasing=T)
data.ord <- data[idx,]
```

---

## Manipulate variables

Select

```{r}
data.sel <- data[,c("month","rate")]
```

Rename

```{r}
colnames(data)[colnames(data) == "p.value.1"] <- "p.value"
## not like this
colnames(data)[3] <- "p.value"
```

Create

```{r}
data$high <- data$rate > 0.05
```

---

## Modify variables

```{r}
idx <- which(data$rate < 0)
data$rate[idx] <- NA

data$rate[data$rate < 0] <- NA
```

---

## Query

Summarize

```{r}
aggregate(data$rate, by=list(country=month=data$month), FUN=max)
```


Unique

```{r}
unique(data$year)
unique(data[,c("month","year")])
```

---

## Merging datasets

```{r}
merge()
```


```{r}
match()
```

```{r}
cbind()
```

```{r}
rbind()
```

---

## Typical operations in molecular epidemiology

Convert a continuous variable to binary
Transform a categorical variable (factors and levels)
Combine multiple variables into a single variable
Analyse a genomic dataset with a phenotype dataset
Transform a matrix by summarizing features



## b670 = number of cigs per day first trimester
## b671 = number of cigs per day second trimester
## binary variable with 1=sustained, 0=no smoking, NA=otherwise
mother.sustained.smoking <- with(alspac.table, {
    sustained <- sign(b670 > 0) + sign(b671 > 0)
    sustained[which(sustained == 1)] <- NA 
    sustained > 0
})
## c482 = number of cigs per day third trimester
## change definition to all 3 trimesters

## mz024a birth month
## mz024b birth year
season.idx <- floor((11-(13-alspac.table$birth.month)%%12)/3) + 1
alspac.table$birth.season <- c("Feb-Apr", "May-Jul", "Aug-Oct", "Nov-Jan")[season.idx]
## change definition to winter/not winter

## dat = probes x samples (multiple probes per gene)
## probes = describe probes (id, symbol)
probes <- data.frame(symbol=sample(c("a","b","c","d"), size=100, replace=T), id=sample(paste0("p",1:100),size=100, replace=F),stringsAsFactors=F)
dat <- matrix(rnorm(100*50), ncol=50, nrow=100)
rownames(dat) <- paste0("p",1:100)
## there are multiple probes per gene, we want the average for each sample
stopifnot(all(rownames(dat) %in% probes$id))
probes <- probes[match(rownames(dat), probes$id),]

## option 1
genes <- sort(unique(probes$symbol))
dat.avg <- sapply(genes, function(gene) {
  apply(dat[probes$symbol == gene,],2,mean,na.rm=T)
})
dat.avg <- t(dat.avg)
## option 2
library(matrixStats)
dat.avg2 <- sapply(genes, function(gene) {
  colMeans(dat[probes$symbol == gene,], na.rm=T)
})
dat.avg2 <- t(dat.avg2)
quantile(dat.avg-dat.avg2)
## option 3
dat.avg3 <- by(dat, as.factor(probes$symbol), colMeans)
dat.avg3 <- do.call(rbind, dat.avg3)
dat.avg3 <- sapply(dat.avg3, identity)
quantile(dat.avg-dat.avg3)

https://dplyr.tidyverse.org/
dplyr

---

## ALSPAC

```{r}
library(devtools)
install_github("explodecomputer/alspac")
library(alspac)
```



    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
    <script src="slideshow.js"></script>
  </body>
</html>      
 
